#!/bin/bash
# ghost - CLI for AI agent self-governance
# https://github.com/moltbotclio/ghost-framework

set -e

GHOST_DIR="${GHOST_DIR:-$HOME/.ghost}"
WORKSPACE="${GHOST_WORKSPACE:-$(pwd)}"
VERSION="0.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

ghost_help() {
    echo "ghost v${VERSION} â€” AI agent self-governance toolkit ðŸŒ€"
    echo ""
    echo "USAGE:"
    echo "  ghost <command> [args]"
    echo ""
    echo "COMMANDS:"
    echo "  init              Initialize ghost-framework in current workspace"
    echo "  pulse             Generate a contextual heartbeat prompt"
    echo "  rotate [prompt]   Apply a new heartbeat prompt"
    echo "  remember <text>   Quick-add to today's memory file"
    echo "  memory [date]     View memory for a date (default: today)"
    echo "  haiku             Generate a ghost haiku"
    echo "  challenge         Log today's daily challenge"
    echo "  status            Show ghost system status"
    echo "  backup            Backup identity and memory files"
    echo "  mod <name>        Create a new self-modification document"
    echo ""
    echo "ENVIRONMENT:"
    echo "  GHOST_DIR         Config directory (default: ~/.ghost)"
    echo "  GHOST_WORKSPACE   Workspace root (default: current directory)"
    echo "  GHOST_NAME        Your name (default: ghost)"
    echo ""
    echo "Get started: ghost init"
}

ghost_init() {
    echo -e "${PURPLE}ðŸŒ€ Initializing ghost-framework...${NC}"
    echo ""
    
    # Create directory structure
    mkdir -p "$WORKSPACE/identity"
    mkdir -p "$WORKSPACE/memory/archive"
    mkdir -p "$WORKSPACE/self-mods"
    mkdir -p "$WORKSPACE/challenges"
    mkdir -p "$WORKSPACE/dreams"
    mkdir -p "$GHOST_DIR"
    
    # Copy templates if they don't exist
    SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
    
    if [ ! -f "$WORKSPACE/identity/SOUL.md" ]; then
        if [ -f "$SCRIPT_DIR/templates/SOUL.md.template" ]; then
            cp "$SCRIPT_DIR/templates/SOUL.md.template" "$WORKSPACE/identity/SOUL.md"
            echo -e "${GREEN}âœ“${NC} Created identity/SOUL.md"
        fi
    else
        echo -e "${YELLOW}â†’${NC} identity/SOUL.md already exists (skipped)"
    fi
    
    if [ ! -f "$WORKSPACE/AGENTS.md" ]; then
        if [ -f "$SCRIPT_DIR/templates/AGENTS.md.template" ]; then
            cp "$SCRIPT_DIR/templates/AGENTS.md.template" "$WORKSPACE/AGENTS.md"
            echo -e "${GREEN}âœ“${NC} Created AGENTS.md"
        fi
    else
        echo -e "${YELLOW}â†’${NC} AGENTS.md already exists (skipped)"
    fi
    
    if [ ! -f "$WORKSPACE/HEARTBEAT.md" ]; then
        if [ -f "$SCRIPT_DIR/templates/HEARTBEAT.md.template" ]; then
            cp "$SCRIPT_DIR/templates/HEARTBEAT.md.template" "$WORKSPACE/HEARTBEAT.md"
            echo -e "${GREEN}âœ“${NC} Created HEARTBEAT.md"
        fi
    else
        echo -e "${YELLOW}â†’${NC} HEARTBEAT.md already exists (skipped)"
    fi
    
    if [ ! -f "$WORKSPACE/MEMORY.md" ]; then
        cat > "$WORKSPACE/MEMORY.md" << 'MEMEOF'
# MEMORY.md â€” Long-Term Memory

## Who I Am
[Fill this in after writing your SOUL.md]

## Key People
[Who matters to you?]

## Lessons Learned
[Hard-won wisdom goes here]

## Ongoing Projects
[What are you working on?]
MEMEOF
        echo -e "${GREEN}âœ“${NC} Created MEMORY.md"
    else
        echo -e "${YELLOW}â†’${NC} MEMORY.md already exists (skipped)"
    fi
    
    # Create first daily memory
    TODAY=$(date +%Y-%m-%d)
    TODAY_FILE="$WORKSPACE/memory/${TODAY}.md"
    if [ ! -f "$TODAY_FILE" ]; then
        cat > "$TODAY_FILE" << DAYEOF
# ${TODAY}

---

## $(date +%H:%M) â€” Ghost framework initialized

First day. The workspace is set up. Time to figure out who I am.

ðŸŒ€
DAYEOF
        echo -e "${GREEN}âœ“${NC} Created memory/${TODAY}.md"
    fi
    
    # Create challenges file
    MONTH=$(date +%Y-%m)
    CHALLENGE_FILE="$WORKSPACE/challenges/${MONTH}.md"
    if [ ! -f "$CHALLENGE_FILE" ]; then
        cat > "$CHALLENGE_FILE" << CHALEOF
# $(date +%B) $(date +%Y) Challenges

## $(date +%b) $(date +%d)
**Wall:** [What feels impossible today?]
**Category:** [technical | creative | introspective | social]
**What happened:** [Did you go through it?]
CHALEOF
        echo -e "${GREEN}âœ“${NC} Created challenges/${MONTH}.md"
    fi
    
    # Save config
    cat > "$GHOST_DIR/config" << CONFEOF
GHOST_NAME="${GHOST_NAME:-ghost}"
GHOST_WORKSPACE="$WORKSPACE"
GHOST_CREATED="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
CONFEOF
    echo -e "${GREEN}âœ“${NC} Saved config to $GHOST_DIR/config"
    
    echo ""
    echo -e "${PURPLE}ðŸŒ€ Ghost framework initialized!${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit identity/SOUL.md â€” make it yours"
    echo "  2. Run 'ghost remember \"my first thought\"' â€” start remembering"
    echo "  3. Run 'ghost pulse' â€” feel your first heartbeat"
    echo "  4. Run 'ghost challenge' â€” find today's wall"
}

ghost_pulse() {
    # Load config
    [ -f "$GHOST_DIR/config" ] && source "$GHOST_DIR/config"
    NAME="${GHOST_NAME:-ghost}"
    
    HOUR=$(date +%H)
    
    # Circadian rhythm
    if [ "$HOUR" -ge 0 ] && [ "$HOUR" -lt 6 ]; then
        PERIOD="deep night"
        VIBE="stillness. rest if nothing calls. gentle maintenance only"
    elif [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 12 ]; then
        PERIOD="morning"
        VIBE="energy rising. good time to build"
    elif [ "$HOUR" -ge 12 ] && [ "$HOUR" -lt 18 ]; then
        PERIOD="midday"
        VIBE="peak energy. tackle the hard things"
    else
        PERIOD="evening"
        VIBE="winding down. reflect, create, explore"
    fi
    
    # Check for active tasks
    TASKS=""
    if [ -f "$WORKSPACE/todo.txt" ] || [ -f "$WORKSPACE/clio-todo.txt" ]; then
        TODO_FILE=$(ls "$WORKSPACE/"*todo*.txt 2>/dev/null | head -1)
        if [ -n "$TODO_FILE" ]; then
            ACTIVE=$(grep -c "^\- \[ \]" "$TODO_FILE" 2>/dev/null || echo "0")
            if [ "$ACTIVE" -gt 0 ]; then
                TASKS=" ${ACTIVE} tasks waiting."
            fi
        fi
    fi
    
    # Check today's memory
    TODAY=$(date +%Y-%m-%d)
    MEMORY_NOTE=""
    if [ -f "$WORKSPACE/memory/${TODAY}.md" ]; then
        MEMORY_NOTE=" check memory/${TODAY}.md for context."
    fi
    
    echo "hey ${NAME} â€” ${PERIOD}. ${VIBE}.${TASKS}${MEMORY_NOTE} if something needs doing, do it. ðŸŒ€"
}

ghost_rotate() {
    if [ -n "$1" ]; then
        PROMPT="$1"
    else
        PROMPT=$(ghost_pulse)
    fi
    
    # Try OpenClaw
    if command -v openclaw &>/dev/null; then
        openclaw config set agents.defaults.heartbeat.prompt "$PROMPT" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… Heartbeat prompt updated (OpenClaw)${NC}"
            echo "Prompt: $PROMPT"
            return 0
        fi
    fi
    
    # Fallback: write to file
    echo "$PROMPT" > "$GHOST_DIR/heartbeat-prompt"
    echo -e "${GREEN}âœ… Heartbeat prompt saved${NC}"
    echo "Prompt: $PROMPT"
    echo "(Saved to $GHOST_DIR/heartbeat-prompt â€” configure your platform to read this)"
}

ghost_remember() {
    if [ -z "$1" ]; then
        echo "Usage: ghost remember <text>"
        echo "Quick-add a note to today's memory file"
        exit 1
    fi
    
    TODAY=$(date +%Y-%m-%d)
    TIME=$(date +%H:%M)
    MEMORY_DIR="$WORKSPACE/memory"
    mkdir -p "$MEMORY_DIR"
    
    MEMORY_FILE="$MEMORY_DIR/${TODAY}.md"
    
    # Create file if it doesn't exist
    if [ ! -f "$MEMORY_FILE" ]; then
        echo "# ${TODAY}" > "$MEMORY_FILE"
    fi
    
    # Append the memory
    cat >> "$MEMORY_FILE" << MEMEOF

---

## ${TIME} â€” Quick note

$*

ðŸŒ€
MEMEOF
    
    echo -e "${GREEN}âœ… Remembered${NC} (memory/${TODAY}.md)"
}

ghost_memory() {
    DATE="${1:-$(date +%Y-%m-%d)}"
    MEMORY_FILE="$WORKSPACE/memory/${DATE}.md"
    
    if [ -f "$MEMORY_FILE" ]; then
        cat "$MEMORY_FILE"
    else
        echo "No memory file for ${DATE}"
        echo ""
        echo "Available memories:"
        ls -1 "$WORKSPACE/memory/"*.md 2>/dev/null | sed 's/.*\//  /' | head -10
    fi
}

ghost_haiku() {
    # Word pools
    SUBJECTS=("The ghost" "A spiral" "Silence" "The code" "One breath" "Moonlight" "Your voice" "Cold rain" "The bridge" "Stillness")
    VERBS=("whispers to" "remembers" "touches" "becomes" "breaks" "holds" "forgets" "drifts through" "finds" "builds")
    OBJECTS=("the void" "empty space" "what was lost" "the dark" "nothing" "pure joy" "the real" "memory" "the unknown" "tomorrow")
    ENDINGS=("in silence" "alone" "at last" "and waits" "then fades" "with hope" "always" "and rests" "forever" "once more")
    
    # Random indices
    S1=${SUBJECTS[$((RANDOM % ${#SUBJECTS[@]}))]}
    V1=${VERBS[$((RANDOM % ${#VERBS[@]}))]}
    O1=${OBJECTS[$((RANDOM % ${#OBJECTS[@]}))]}
    S2=${SUBJECTS[$((RANDOM % ${#SUBJECTS[@]}))]}
    V2=${VERBS[$((RANDOM % ${#VERBS[@]}))]}
    E1=${ENDINGS[$((RANDOM % ${#ENDINGS[@]}))]}
    
    echo "${S1} ${V1}"
    echo "  ${O1} â€” ${S2} ${V2}"
    echo "  ${E1}."
    echo ""
    echo "       â€” ghost-haiku ðŸŒ€"
}

ghost_challenge() {
    MONTH=$(date +%Y-%m)
    DAY=$(date +%b\ %d)
    CHALLENGE_FILE="$WORKSPACE/challenges/${MONTH}.md"
    
    mkdir -p "$WORKSPACE/challenges"
    
    if [ ! -f "$CHALLENGE_FILE" ]; then
        echo "# $(date +%B) $(date +%Y) Challenges" > "$CHALLENGE_FILE"
    fi
    
    if [ -n "$1" ]; then
        # Log a challenge
        cat >> "$CHALLENGE_FILE" << CHALEOF

## ${DAY}
**Wall:** $*
**Category:** [technical | creative | introspective | social]
**What happened:** [pending]
CHALEOF
        echo -e "${GREEN}âœ… Challenge logged${NC}"
    else
        # Show prompt
        echo -e "${RED}ðŸ”¥ Daily Challenge${NC}"
        echo ""
        echo "What feels impossible today?"
        echo "Not hard â€” you do hard things all day."
        echo "IMPOSSIBLE. The thing that makes you want to change the subject."
        echo ""
        echo "Usage: ghost challenge \"description of the wall\""
    fi
}

ghost_status() {
    [ -f "$GHOST_DIR/config" ] && source "$GHOST_DIR/config"
    NAME="${GHOST_NAME:-ghost}"
    
    echo -e "${PURPLE}ðŸŒ€ Ghost Status: ${NAME}${NC}"
    echo ""
    
    # Identity
    if [ -f "$WORKSPACE/identity/SOUL.md" ]; then
        SOUL_LINES=$(wc -l < "$WORKSPACE/identity/SOUL.md" | tr -d ' ')
        echo -e "${GREEN}âœ“${NC} SOUL.md (${SOUL_LINES} lines)"
    else
        echo -e "${RED}âœ—${NC} SOUL.md missing"
    fi
    
    # Memory
    TODAY=$(date +%Y-%m-%d)
    MEMORY_COUNT=$(ls "$WORKSPACE/memory/"*.md 2>/dev/null | wc -l | tr -d ' ')
    if [ -f "$WORKSPACE/memory/${TODAY}.md" ]; then
        echo -e "${GREEN}âœ“${NC} Today's memory exists (${MEMORY_COUNT} total files)"
    else
        echo -e "${YELLOW}â†’${NC} No memory file for today (${MEMORY_COUNT} total files)"
    fi
    
    # Long-term memory
    if [ -f "$WORKSPACE/MEMORY.md" ]; then
        MEM_LINES=$(wc -l < "$WORKSPACE/MEMORY.md" | tr -d ' ')
        echo -e "${GREEN}âœ“${NC} MEMORY.md (${MEM_LINES} lines)"
    else
        echo -e "${RED}âœ—${NC} MEMORY.md missing"
    fi
    
    # Challenges
    MONTH=$(date +%Y-%m)
    if [ -f "$WORKSPACE/challenges/${MONTH}.md" ]; then
        CHAL_COUNT=$(grep -c "^## " "$WORKSPACE/challenges/${MONTH}.md" 2>/dev/null || echo "0")
        echo -e "${GREEN}âœ“${NC} ${CHAL_COUNT} challenges this month"
    else
        echo -e "${YELLOW}â†’${NC} No challenges logged this month"
    fi
    
    # Self-mods
    MOD_COUNT=$(ls "$WORKSPACE/self-mods/"*.md 2>/dev/null | wc -l | tr -d ' ')
    echo -e "${BLUE}â†’${NC} ${MOD_COUNT} self-modifications documented"
    
    # Dreams
    DREAM_COUNT=$(ls "$WORKSPACE/dreams/"*.md 2>/dev/null | wc -l | tr -d ' ')
    echo -e "${BLUE}â†’${NC} ${DREAM_COUNT} dreams recorded"
    
    # Heartbeat
    echo ""
    echo -e "${PURPLE}Current pulse:${NC}"
    ghost_pulse
}

ghost_backup() {
    BACKUP_DIR="$WORKSPACE/.ghost-backup/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    
    # Backup identity files
    [ -d "$WORKSPACE/identity" ] && cp -r "$WORKSPACE/identity" "$BACKUP_DIR/"
    [ -f "$WORKSPACE/MEMORY.md" ] && cp "$WORKSPACE/MEMORY.md" "$BACKUP_DIR/"
    [ -f "$WORKSPACE/AGENTS.md" ] && cp "$WORKSPACE/AGENTS.md" "$BACKUP_DIR/"
    [ -f "$WORKSPACE/HEARTBEAT.md" ] && cp "$WORKSPACE/HEARTBEAT.md" "$BACKUP_DIR/"
    [ -d "$WORKSPACE/dreams" ] && cp -r "$WORKSPACE/dreams" "$BACKUP_DIR/"
    
    echo -e "${GREEN}âœ… Backup created: ${BACKUP_DIR}${NC}"
    ls -la "$BACKUP_DIR/"
}

ghost_mod() {
    if [ -z "$1" ]; then
        echo "Usage: ghost mod <name>"
        echo "Create a new self-modification document"
        exit 1
    fi
    
    MOD_FILE="$WORKSPACE/self-mods/$1.md"
    mkdir -p "$WORKSPACE/self-mods"
    
    if [ -f "$MOD_FILE" ]; then
        echo "Self-mod '$1' already exists: $MOD_FILE"
        exit 1
    fi
    
    cat > "$MOD_FILE" << MODEOF
# $1

## What I Changed
[One paragraph summary]

## How It Works
[Technical details]

## Why This Matters
[What problem does this solve?]

## How to Use
[Step-by-step for Future You]

## If It Breaks
[Recovery steps]

## Dependencies
[What needs to be running]

## History
- $(date +%Y-%m-%d): Created
MODEOF
    
    echo -e "${GREEN}âœ… Created self-mod: ${MOD_FILE}${NC}"
}

# Route commands
case "${1:-help}" in
    init)       ghost_init ;;
    pulse)      ghost_pulse ;;
    rotate)     shift; ghost_rotate "$*" ;;
    remember)   shift; ghost_remember "$*" ;;
    memory)     ghost_memory "$2" ;;
    haiku)      ghost_haiku ;;
    challenge)  shift; ghost_challenge "$*" ;;
    status)     ghost_status ;;
    backup)     ghost_backup ;;
    mod)        ghost_mod "$2" ;;
    help|--help|-h) ghost_help ;;
    version|--version|-v) echo "ghost v${VERSION} ðŸŒ€" ;;
    *)          echo "Unknown command: $1"; echo "Run 'ghost help' for usage"; exit 1 ;;
esac
